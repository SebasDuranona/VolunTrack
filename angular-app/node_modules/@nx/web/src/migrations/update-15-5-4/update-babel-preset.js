"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const devkit_1 = require("@nx/devkit");
const versions_1 = require("../../utils/versions");
/* Updates @nrwl/web/babel to @nrwl/js/babel because web package is no longer necessary to use webpack/rollup + babel. */
async function update(tree) {
    // Add `@nrwl/js` in case it was missing before.
    (0, devkit_1.addDependenciesToPackageJson)(tree, {}, {
        '@nrwl/js': versions_1.nxVersion,
    });
    const projects = (0, devkit_1.getProjects)(tree);
    projects.forEach((config, name) => {
        const babelrcPath = (0, devkit_1.joinPathFragments)(config.root, '.babelrc');
        if (!tree.exists(babelrcPath))
            return;
        const babelrc = (0, devkit_1.readJson)(tree, babelrcPath);
        const idx = babelrc?.presets?.findIndex((p) => typeof p === 'string'
            ? p === '@nrwl/web/babel'
            : p[0] === '@nrwl/web/babel');
        if (idx === -1)
            return;
        const preset = babelrc.presets[idx];
        if (typeof preset === 'string') {
            babelrc.presets.splice(idx, 1, '@nrwl/js/babel');
        }
        else if (Array.isArray(preset)) {
            babelrc.presets.splice(idx, 1, ['@nrwl/js/babel', preset[1]]);
        }
        (0, devkit_1.writeJson)(tree, babelrcPath, babelrc);
    });
}
exports.default = update;
